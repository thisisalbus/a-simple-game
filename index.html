<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Word Battlefield ‚Äî War Vocabulary Game</title>
  <style>
    :root{--bg:#1a1f1a;--card:#0f130f;--accent:#8ac249;--accent2:#c19a6b;--muted:#a39b8d;--danger:#c0392b;--warning:#f39c12}
    *{box-sizing:border-box;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#0d0d0d 0%, #1a1a1a 60%);color:#e6eef8}
    .container{max-width:1100px;margin:26px auto;padding:22px}
    header{display:flex;align-items:center;gap:18px}
    .logo{width:68px;height:68px;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#04263b;font-size:26px;box-shadow:0 8px 30px rgba(6,12,24,.6)}
    h1{margin:0;font-size:22px}
    p.lead{margin-top:6px;color:var(--muted)}
    .main{display:grid;grid-template-columns:340px 1fr;gap:18px;margin-top:18px}

    /* left panel */
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,.6)}
    .menu button{display:block;width:100%;padding:12px;border-radius:10px;border:0;background:transparent;color:inherit;text-align:left;margin-bottom:8px;font-weight:600;cursor:pointer}
    .menu button.active{background:rgba(255,255,255,0.03);box-shadow:inset 0 1px 0 rgba(255,255,255,0.02)}
    .score{margin-top:12px;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02)}
    .score .big{font-size:28px;font-weight:800}
    .small{color:var(--muted);font-size:13px}

    /* right content */
    .content{min-height:420px;padding:18px;border-radius:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px}
    .controls{display:flex;gap:10px;align-items:center;margin-bottom:12px}
    .btn{background:linear-gradient(90deg,var(--accent2),var(--accent));padding:10px 14px;border-radius:10px;border:0;color:#04263b;font-weight:700;cursor:pointer}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:10px 12px;border-radius:10px}

    /* quiz */
    .question{font-size:20px;font-weight:700;margin:12px 0}
    .options{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .option{padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);cursor:pointer;border:1px solid transparent}
    .option:hover{transform:translateY(-3px)}
    .option.correct{outline:3px solid rgba(138,194,73,0.14);background:linear-gradient(90deg, rgba(138,194,73,0.04), rgba(193,154,107,0.02));}
    .option.wrong{outline:3px solid rgba(192,57,43,0.12);opacity:.9}

    /* level progress */
    .level-progress{margin-top:15px}
    .progress-bar{height:10px;background:rgba(255,255,255,0.1);border-radius:5px;overflow:hidden;margin-top:5px}
    .progress-fill{height:100%;background:var(--accent);border-radius:5px;transition:width 0.3s ease}
    
    /* health & strength bars */
    .stat-bars{display:flex;gap:15px;margin-top:15px}
    .stat-bar{flex:1}
    .stat-label{display:flex;justify-content:space-between;margin-bottom:5px;font-size:14px}
    .bar-container{height:10px;background:rgba(255,255,255,0.1);border-radius:5px;overflow:hidden}
    .health-fill{height:100%;background:var(--danger);border-radius:5px;transition:width 0.3s ease}
    .strength-fill{height:100%;background:var(--warning);border-radius:5px;transition:width 0.3s ease}
    
    /* level indicator */
    .level-indicator{display:flex;align-items:center;gap:10px;margin-bottom:15px}
    .level-badge{padding:5px 10px;background:var(--accent);color:#000;border-radius:20px;font-weight:bold;font-size:14px}
    
    /* badges */
    .badges{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}
    .badge{padding:5px 10px;background:var(--accent2);color:#000;border-radius:20px;font-size:12px;font-weight:bold}
    
    /* game over modal */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center}
    .modal-content{background:var(--card);padding:25px;border-radius:12px;max-width:500px;width:90%;box-shadow:0 10px 30px rgba(0,0,0,0.5);text-align:center}
    .modal-header{font-size:24px;font-weight:700;margin-bottom:15px;color:var(--accent)}
    .modal-body{margin-bottom:20px}
    .modal-buttons{display:flex;gap:10px;justify-content:center}

    /* responsive */
    @media(max-width:900px){.main{grid-template-columns:1fr;}.logo{width:58px;height:58px}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">‚öîÔ∏è</div>
      <div style="flex:1">
        <h1 id="title">Word Battlefield ‚Äî War Vocabulary Game</h1>
        <p class="lead" id="lead">Build your vocabulary army to defeat the enemy! Learn war-related terms through strategic battles.</p>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
        <div style="display:flex;gap:6px">
          <button id="langEn" class="ghost">EN</button>
          <button id="langVi" class="ghost">VI</button>
        </div>
        <a id="downloadBtn" class="btn" href="#" download="word-battlefield.html">Download HTML</a>
      </div>
    </header>

    <div class="main">
      <aside class="panel">
        <div class="menu">
          <button id="btn-battle" class="active">‚öîÔ∏è Battle</button>
          <button id="btn-barracks">üè∞ Barracks</button>
          <button id="btn-edit">‚úèÔ∏è Edit Words</button>
        </div>

        <div class="score">
          <div class="big" id="score">Army: 0</div>
          <div class="small">Level: <span id="level">1</span> ‚Ä¢ Health: <span id="health">100</span></div>
        </div>

        <div class="stat-bars">
          <div class="stat-bar">
            <div class="stat-label">
              <span>Health</span>
              <span id="healthPercent">100%</span>
            </div>
            <div class="bar-container">
              <div id="healthBar" class="health-fill" style="width:100%"></div>
            </div>
          </div>
          <div class="stat-bar">
            <div class="stat-label">
              <span>Army Strength</span>
              <span id="strengthValue">0</span>
            </div>
            <div class="bar-container">
              <div id="strengthBar" class="strength-fill" style="width:0%"></div>
            </div>
          </div>
        </div>

        <div class="level-progress">
          <div class="level-indicator">
            <span>Current Mission:</span>
            <div id="currentLevel" class="level-badge">Level 1: Boot Camp</div>
          </div>
          <div class="progress-bar">
            <div id="levelProgress" class="progress-fill" style="width:0%"></div>
          </div>
          <div class="small" style="margin-top:5px">Progress: <span id="progressText">0/5</span></div>
        </div>

        <div class="badges" id="badgesContainer">
          <div class="badge" style="background:#555">No Badges Yet</div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;">
          <button id="btn-reset" class="ghost">Reset Game</button>
          <button id="btn-help" class="ghost">How to Play</button>
        </div>
      </aside>

      <section class="content">
        <div id="view-battle" class="card">
          <div class="controls">
            <button id="nextBattle" class="btn">Start Battle</button>
            <div style="margin-left:auto" class="small">Timer: <span id="timer">--</span></div>
          </div>
          <div id="battleArea">
            <div class="question" id="questionText">Press "Start Battle" to begin your first mission!</div>
            <div class="options" id="options"></div>
          </div>
        </div>

        <div id="view-barracks" class="card" style="margin-top:12px;display:none">
          <div class="small">Your barracks. Here you can review the vocabulary you've learned and prepare for battle.</div>
          <div style="margin-top:15px">
            <h3 style="margin-top:0">Your Vocabulary Army</h3>
            <div id="barracksContent" style="margin-top:10px">
              <p style="color:var(--muted)">Complete battles to unlock words in your barracks.</p>
            </div>
          </div>
        </div>

        <div id="view-edit" class="card" style="margin-top:12px;display:none">
          <div class="small">Edit the vocabulary list (JSON). Structure: {"level1":[...], "level2":[...], "level3":[...], "finalBoss":[...]}</div>
          <textarea id="vocabJson" style="width:100%;height:260px;margin-top:8px;border-radius:8px;padding:10px;background:#031524;color:#ccdef7;border:1px solid rgba(255,255,255,0.03);"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="saveVocab" class="btn">Save</button>
            <button id="resetVocab" class="ghost">Reset to Default</button>
          </div>
        </div>

      </section>
    </div>

    <footer id="footer">Build your vocabulary army to conquer the battlefield! Complete all missions to become a Word Commander.</footer>
  </div>

  <!-- Game Over Modal -->
  <div id="gameOverModal" class="modal">
    <div class="modal-content">
      <div class="modal-header" id="gameOverTitle">Game Over</div>
      <div class="modal-body" id="gameOverMessage">
        Your army has been defeated. Try again to build a stronger vocabulary force!
      </div>
      <div class="modal-buttons">
        <button id="restartBtn" class="btn">Restart Game</button>
      </div>
    </div>
  </div>

  <!-- Level Complete Modal -->
  <div id="levelCompleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header" id="levelCompleteTitle">Mission Complete!</div>
      <div class="modal-body" id="levelCompleteMessage">
        You've successfully completed this mission. Your army grows stronger!
      </div>
      <div class="modal-buttons">
        <button id="nextLevelBtn" class="btn">Next Mission</button>
      </div>
    </div>
  </div>

<script>
/* ===== language & strings ===== */
let LANG='en';
const STRINGS = {
  en: {
    battle:'‚öîÔ∏è Battle', barracks:'üè∞ Barracks', edit:'‚úèÔ∏è Edit Words',
    tip:'Build your vocabulary army to conquer the battlefield! Complete all missions to become a Word Commander.',
    how: `Word Battlefield - War Vocabulary Game

How to Play:
1. Start at Level 1 (Boot Camp) and progress through missions.
2. Each battle presents a war-related vocabulary word.
3. Choose the correct definition from 4 options.
4. Correct answers strengthen your army (+10 strength).
5. Wrong answers reduce your health (-5 health).
6. Complete each level by answering the required number of questions correctly.
7. Earn badges for completing missions: The Strategist, The Commander, The Conqueror.
8. Defeat the Final Boss to win the game!

Game Over: If your health reaches 0, your army is defeated.

Good luck, Commander!`,
    scoring: `Scoring System:
‚Ä¢ Correct answer: +10 Army Strength
‚Ä¢ Wrong answer: -5 Health
‚Ä¢ Level 1: Complete 5 correct answers
‚Ä¢ Level 2: Complete 7 correct answers
‚Ä¢ Level 3: Complete 10 correct answers
‚Ä¢ Final Boss: Get 10 out of 12 questions correct
‚Ä¢ Badges: Earned for completing each level`,
    level1: "Level 1: Boot Camp",
    level2: "Level 2: Battlefield",
    level3: "Level 3: Campaign",
    finalBoss: "Final Boss: Ultimate Battle",
    gameOver: "Game Over",
    gameOverMsg: "Your army has been defeated. Try again to build a stronger vocabulary force!",
    levelComplete: "Mission Complete!",
    levelCompleteMsg: "You've successfully completed this mission. Your army grows stronger!",
    restart: "Restart Game",
    nextLevel: "Next Mission",
    noBadges: "No Badges Yet",
    barracksEmpty: "Complete battles to unlock words in your barracks.",
    startBattle: "Start Battle",
    pressStart: "Press \"Start Battle\" to begin your first mission!"
  },
  vi: {
    battle:'‚öîÔ∏è Tr·∫≠n chi·∫øn', barracks:'üè∞ Doanh tr·∫°i', edit:'‚úèÔ∏è Ch·ªânh s·ª≠a t·ª´',
    tip:'X√¢y d·ª±ng ƒë·ªôi qu√¢n t·ª´ v·ª±ng ƒë·ªÉ chinh ph·ª•c chi·∫øn tr∆∞·ªùng! Ho√†n th√†nh t·∫•t c·∫£ nhi·ªám v·ª• ƒë·ªÉ tr·ªü th√†nh Ch·ªâ huy t·ª´ v·ª±ng.',
    how: `Chi·∫øn tr∆∞·ªùng T·ª´ v·ª±ng - Tr√≤ ch∆°i T·ª´ v·ª±ng Ch·ªß ƒë·ªÅ Chi·∫øn tranh

C√°ch ch∆°i:
1. B·∫Øt ƒë·∫ßu ·ªü C·∫•p ƒë·ªô 1 (Tr·∫°i l√≠nh) v√† ti·∫øn h√†nh c√°c nhi·ªám v·ª•.
2. M·ªói tr·∫≠n chi·∫øn ƒë∆∞a ra m·ªôt t·ª´ v·ª±ng li√™n quan ƒë·∫øn chi·∫øn tranh.
3. Ch·ªçn ƒë·ªãnh nghƒ©a ƒë√∫ng t·ª´ 4 l·ª±a ch·ªçn.
4. Tr·∫£ l·ªùi ƒë√∫ng l√†m ƒë·ªôi qu√¢n c·ªßa b·∫°n m·∫°nh h∆°n (+10 s·ª©c m·∫°nh).
5. Tr·∫£ l·ªùi sai l√†m gi·∫£m m√°u c·ªßa b·∫°n (-5 m√°u).
6. Ho√†n th√†nh m·ªói c·∫•p ƒë·ªô b·∫±ng c√°ch tr·∫£ l·ªùi ƒë√∫ng s·ªë c√¢u h·ªèi c·∫ßn thi·∫øt.
7. Nh·∫≠n huy hi·ªáu khi ho√†n th√†nh nhi·ªám v·ª•: Nh√† chi·∫øn l∆∞·ª£c, Ch·ªâ huy, Ng∆∞·ªùi chinh ph·ª•c.
8. ƒê√°nh b·∫°i Tr√πm cu·ªëi ƒë·ªÉ th·∫Øng tr√≤ ch∆°i!

Tr√≤ ch∆°i k·∫øt th√∫c: N·∫øu m√°u c·ªßa b·∫°n v·ªÅ 0, ƒë·ªôi qu√¢n c·ªßa b·∫°n b·ªã ƒë√°nh b·∫°i.

Ch√∫c may m·∫Øn, Ch·ªâ huy!`,
    scoring: `H·ªá th·ªëng t√≠nh ƒëi·ªÉm:
‚Ä¢ Tr·∫£ l·ªùi ƒë√∫ng: +10 S·ª©c m·∫°nh ƒë·ªôi qu√¢n
‚Ä¢ Tr·∫£ l·ªùi sai: -5 M√°u
‚Ä¢ C·∫•p ƒë·ªô 1: Ho√†n th√†nh 5 c√¢u tr·∫£ l·ªùi ƒë√∫ng
‚Ä¢ C·∫•p ƒë·ªô 2: Ho√†n th√†nh 7 c√¢u tr·∫£ l·ªùi ƒë√∫ng
‚Ä¢ C·∫•p ƒë·ªô 3: Ho√†n th√†nh 10 c√¢u tr·∫£ l·ªùi ƒë√∫ng
‚Ä¢ Tr√πm cu·ªëi: Tr·∫£ l·ªùi ƒë√∫ng 10/12 c√¢u h·ªèi
‚Ä¢ Huy hi·ªáu: Nh·∫≠n ƒë∆∞·ª£c khi ho√†n th√†nh m·ªói c·∫•p ƒë·ªô`,
    level1: "C·∫•p ƒë·ªô 1: Tr·∫°i l√≠nh",
    level2: "C·∫•p ƒë·ªô 2: Chi·∫øn tr∆∞·ªùng",
    level3: "C·∫•p ƒë·ªô 3: Chi·∫øn d·ªãch",
    finalBoss: "Tr√πm cu·ªëi: Tr·∫≠n chi·∫øn cu·ªëi c√πng",
    gameOver: "Tr√≤ ch∆°i k·∫øt th√∫c",
    gameOverMsg: "ƒê·ªôi qu√¢n c·ªßa b·∫°n ƒë√£ b·ªã ƒë√°nh b·∫°i. H√£y th·ª≠ l·∫°i ƒë·ªÉ x√¢y d·ª±ng ƒë·ªôi qu√¢n t·ª´ v·ª±ng m·∫°nh h∆°n!",
    levelComplete: "Nhi·ªám v·ª• ho√†n th√†nh!",
    levelCompleteMsg: "B·∫°n ƒë√£ ho√†n th√†nh th√†nh c√¥ng nhi·ªám v·ª• n√†y. ƒê·ªôi qu√¢n c·ªßa b·∫°n ng√†y c√†ng m·∫°nh h∆°n!",
    restart: "Ch∆°i l·∫°i",
    nextLevel: "Nhi·ªám v·ª• ti·∫øp theo",
    noBadges: "Ch∆∞a c√≥ huy hi·ªáu",
    barracksEmpty: "Ho√†n th√†nh c√°c tr·∫≠n chi·∫øn ƒë·ªÉ m·ªü kh√≥a t·ª´ v·ª±ng trong doanh tr·∫°i.",
    startBattle: "B·∫Øt ƒë·∫ßu tr·∫≠n chi·∫øn",
    pressStart: "Nh·∫•n \"B·∫Øt ƒë·∫ßu tr·∫≠n chi·∫øn\" ƒë·ªÉ b·∫Øt ƒë·∫ßu nhi·ªám v·ª• ƒë·∫ßu ti√™n c·ªßa b·∫°n!"
  }
};
function t(k){return STRINGS[LANG][k]||k}

/* ===== vocabulary (default) ===== */
let defaultVocab = {
  level1: [
    {word:"soldier",def:"A person who serves in an army.",example:"The soldier fought bravely in the battle.",viDef:"Ng∆∞·ªùi ph·ª•c v·ª• trong qu√¢n ƒë·ªôi.",viExample:"Ng∆∞·ªùi l√≠nh ƒë√£ chi·∫øn ƒë·∫•u d≈©ng c·∫£m trong tr·∫≠n ƒë√°nh.",cat:"war"},
    {word:"army",def:"An organized military force equipped for fighting.",example:"The army marched toward the enemy territory.",viDef:"L·ª±c l∆∞·ª£ng qu√¢n s·ª± c√≥ t·ªï ch·ª©c ƒë∆∞·ª£c trang b·ªã ƒë·ªÉ chi·∫øn ƒë·∫•u.",viExample:"Qu√¢n ƒë·ªôi ƒë√£ h√†nh qu√¢n v·ªÅ ph√≠a l√£nh th·ªï k·∫ª th√π.",cat:"war"},
    {word:"weapon",def:"A thing designed or used for inflicting bodily harm or physical damage.",example:"Soldiers carry weapons for protection.",viDef:"V·∫≠t ƒë∆∞·ª£c thi·∫øt k·∫ø ho·∫∑c s·ª≠ d·ª•ng ƒë·ªÉ g√¢y ra t·ªïn th∆∞∆°ng th·ªÉ ch·∫•t ho·∫∑c thi·ªát h·∫°i v·∫≠t ch·∫•t.",viExample:"Ng∆∞·ªùi l√≠nh mang v≈© kh√≠ ƒë·ªÉ t·ª± v·ªá.",cat:"war"},
    {word:"shield",def:"A broad piece of metal or another material held by soldiers to protect the body from weapons.",example:"The knight raised his shield to block the attack.",viDef:"M·ªôt m·∫£nh kim lo·∫°i r·ªông ho·∫∑c v·∫≠t li·ªáu kh√°c ƒë∆∞·ª£c ng∆∞·ªùi l√≠nh c·∫ßm ƒë·ªÉ b·∫£o v·ªá c∆° th·ªÉ kh·ªèi v≈© kh√≠.",viExample:"Hi·ªáp sƒ© ƒë√£ khi√™n c·ªßa m√¨nh l√™n ƒë·ªÉ ch·∫∑n ƒë√≤n t·∫•n c√¥ng.",cat:"war"},
    {word:"enemy",def:"A person or group that is actively opposed or hostile to someone or something.",example:"The enemy troops were approaching from the north.",viDef:"M·ªôt ng∆∞·ªùi ho·∫∑c nh√≥m t√≠ch c·ª±c ph·∫£n ƒë·ªëi ho·∫∑c th√π ƒë·ªãch v·ªõi ai ƒë√≥ ho·∫∑c ƒëi·ªÅu g√¨ ƒë√≥.",viExample:"Qu√¢n ƒë·ªôi k·∫ª th√π ƒëang ti·∫øp c·∫≠n t·ª´ ph√≠a b·∫Øc.",cat:"war"},
    {word:"fight",def:"Take part in a violent struggle involving the exchange of physical blows or the use of weapons.",example:"The soldiers began to fight when they saw the enemy.",viDef:"Tham gia v√†o m·ªôt cu·ªôc ƒë·∫•u tranh b·∫°o l·ª±c li√™n quan ƒë·∫øn vi·ªác trao ƒë·ªïi ƒë√≤n t·∫•n c√¥ng v·∫≠t l√Ω ho·∫∑c s·ª≠ d·ª•ng v≈© kh√≠.",viExample:"Nh·ªØng ng∆∞·ªùi l√≠nh b·∫Øt ƒë·∫ßu chi·∫øn ƒë·∫•u khi h·ªç th·∫•y k·∫ª th√π.",cat:"war"},
    {word:"battle",def:"A sustained fight between large organized armed forces.",example:"The battle lasted for three days.",viDef:"Cu·ªôc chi·∫øn ƒë·∫•u k√©o d√†i gi·ªØa c√°c l·ª±c l∆∞·ª£ng v≈© trang l·ªõn c√≥ t·ªï ch·ª©c.",viExample:"Tr·∫≠n ƒë√°nh k√©o d√†i trong ba ng√†y.",cat:"war"},
    {word:"troops",def:"Soldiers or armed forces.",example:"The troops were deployed to the conflict zone.",viDef:"Nh·ªØng ng∆∞·ªùi l√≠nh ho·∫∑c l·ª±c l∆∞·ª£ng v≈© trang.",viExample:"C√°c qu√¢n ƒë·ªôi ƒë√£ ƒë∆∞·ª£c tri·ªÉn khai ƒë·∫øn khu v·ª±c xung ƒë·ªôt.",cat:"war"}
  ],
  level2: [
    {word:"strategy",def:"A plan of action designed to achieve a long-term or overall aim.",example:"The general developed a new strategy to win the war.",viDef:"M·ªôt k·∫ø ho·∫°ch h√†nh ƒë·ªông ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ ƒë·∫°t ƒë∆∞·ª£c m·ª•c ti√™u d√†i h·∫°n ho·∫∑c t·ªïng th·ªÉ.",viExample:"T∆∞·ªõng ƒë√£ ph√°t tri·ªÉn m·ªôt chi·∫øn l∆∞·ª£c m·ªõi ƒë·ªÉ th·∫Øng cu·ªôc chi·∫øn.",cat:"war"},
    {word:"commander",def:"A person in authority, especially in a military context.",example:"The commander gave orders to advance.",viDef:"Ng∆∞·ªùi c√≥ quy·ªÅn l·ª±c, ƒë·∫∑c bi·ªát trong b·ªëi c·∫£nh qu√¢n s·ª±.",viExample:"Ch·ªâ huy ƒë√£ ra l·ªánh ti·∫øn c√¥ng.",cat:"war"},
    {word:"ally",def:"A state or person cooperating with another for a military or other purpose.",example:"The two countries were allies in the war.",viDef:"M·ªôt qu·ªëc gia ho·∫∑c ng∆∞·ªùi h·ª£p t√°c v·ªõi m·ªôt ng∆∞·ªùi kh√°c cho m·ª•c ƒë√≠ch qu√¢n s·ª± ho·∫∑c kh√°c.",viExample:"Hai qu·ªëc gia l√† ƒë·ªìng minh trong cu·ªôc chi·∫øn.",cat:"war"},
    {word:"invade",def:"Enter (a country or territory) with armed forces in order to attack, damage, or occupy it.",example:"The army prepared to invade the neighboring country.",viDef:"Nh·∫≠p v√†o (m·ªôt qu·ªëc gia ho·∫∑c l√£nh th·ªï) v·ªõi l·ª±c l∆∞·ª£ng v≈© trang ƒë·ªÉ t·∫•n c√¥ng, g√¢y thi·ªát h·∫°i, ho·∫∑c chi·∫øm ƒë√≥ng n√≥.",viExample:"Qu√¢n ƒë·ªôi ƒë√£ chu·∫©n b·ªã ƒë·ªÉ x√¢m l∆∞·ª£c qu·ªëc gia l√°ng gi·ªÅng.",cat:"war"},
    {word:"defend",def:"Protect from harm or danger; resist attack.",example:"The soldiers had to defend the fortress.",viDef:"B·∫£o v·ªá kh·ªèi t·ªïn h·∫°i ho·∫∑c nguy hi·ªÉm; kh√°ng c·ª± s·ª± t·∫•n c√¥ng.",viExample:"Nh·ªØng ng∆∞·ªùi l√≠nh ph·∫£i b·∫£o v·ªá ph√°o ƒë√†i.",cat:"war"},
    {word:"surrender",def:"Cease resistance to an enemy or opponent and submit to their authority.",example:"The troops were forced to surrender.",viDef:"Ng·ª´ng kh√°ng c·ª± k·∫ª th√π ho·∫∑c ƒë·ªëi th·ªß v√† ch·ªãu s·ª± ki·ªÉm so√°t c·ªßa h·ªç.",viExample:"C√°c qu√¢n ƒë·ªôi ƒë√£ bu·ªôc ph·∫£i ƒë·∫ßu h√†ng.",cat:"war"},
    {word:"retreat",def:"Withdraw from enemy forces as a result of their superior power or after a defeat.",example:"The army had to retreat after losing the battle.",viDef:"R√∫t lui kh·ªèi l·ª±c l∆∞·ª£ng k·∫ª th√π do s·ª©c m·∫°nh v∆∞·ª£t tr·ªôi c·ªßa h·ªç ho·∫∑c sau m·ªôt th·∫•t b·∫°i.",viExample:"Qu√¢n ƒë·ªôi ƒë√£ ph·∫£i r√∫t lui sau khi thua tr·∫≠n.",cat:"war"},
    {word:"victory",def:"An act of defeating an enemy or opponent.",example:"The celebration lasted for days after the victory.",viDef:"H√†nh ƒë·ªông ƒë√°nh b·∫°i k·∫ª th√π ho·∫∑c ƒë·ªëi th·ªß.",viExample:"L·ªÖ k·ª∑ ni·ªám k√©o d√†i nhi·ªÅu ng√†y sau chi·∫øn th·∫Øng.",cat:"war"},
    {word:"defeat",def:"Win against (an enemy or opponent) in a battle or other contest.",example:"The army was determined to defeat its enemies.",viDef:"Th·∫Øng (k·∫ª th√π ho·∫∑c ƒë·ªëi th·ªß) trong m·ªôt tr·∫≠n chi·∫øn ho·∫∑c cu·ªôc thi kh√°c.",viExample:"Qu√¢n ƒë·ªôi quy·∫øt t√¢m ƒë√°nh b·∫°i k·∫ª th√π c·ªßa m√¨nh.",cat:"war"},
    {word:"combat",def:"Fighting between armed forces.",example:"The soldiers were engaged in combat.",viDef:"Cu·ªôc chi·∫øn ƒë·∫•u gi·ªØa c√°c l·ª±c l∆∞·ª£ng v≈© trang.",viExample:"Nh·ªØng ng∆∞·ªùi l√≠nh ƒëang tham gia chi·∫øn ƒë·∫•u.",cat:"war"}
  ],
  level3: [
    {word:"conflict",def:"A serious disagreement or argument, typically a protracted one.",example:"The conflict between the two nations lasted for decades.",viDef:"M·ªôt b·∫•t ƒë·ªìng ho·∫∑c tranh c√£i nghi√™m tr·ªçng, th∆∞·ªùng l√† k√©o d√†i.",viExample:"Xung ƒë·ªôt gi·ªØa hai qu·ªëc gia k√©o d√†i trong nhi·ªÅu th·∫≠p k·ª∑.",cat:"war"},
    {word:"negotiate",def:"Discuss something with someone in order to reach an agreement.",example:"The leaders met to negotiate a peace treaty.",viDef:"Th·∫£o lu·∫≠n ƒëi·ªÅu g√¨ ƒë√≥ v·ªõi ai ƒë√≥ ƒë·ªÉ ƒë·∫°t ƒë∆∞·ª£c th·ªèa thu·∫≠n.",viExample:"C√°c nh√† l√£nh ƒë·∫°o ƒë√£ g·∫∑p nhau ƒë·ªÉ ƒë√†m ph√°n m·ªôt hi·ªáp ∆∞·ªõc h√≤a b√¨nh.",cat:"war"},
    {word:"treaty",def:"A formally concluded and ratified agreement between states.",example:"The two countries signed a peace treaty.",viDef:"M·ªôt th·ªèa thu·∫≠n ƒë∆∞·ª£c k·∫øt lu·∫≠n v√† ph√™ chu·∫©n ch√≠nh th·ª©c gi·ªØa c√°c qu·ªëc gia.",viExample:"Hai qu·ªëc gia ƒë√£ k√Ω m·ªôt hi·ªáp ∆∞·ªõc h√≤a b√¨nh.",cat:"war"},
    {word:"occupy",def:"Take control of (a place, especially a country) by military force.",example:"The invading army began to occupy the city.",viDef:"N·∫Øm quy·ªÅn ki·ªÉm so√°t (m·ªôt n∆°i, ƒë·∫∑c bi·ªát l√† m·ªôt qu·ªëc gia) b·∫±ng l·ª±c l∆∞·ª£ng qu√¢n s·ª±.",viExample:"Qu√¢n ƒë·ªôi x√¢m l∆∞·ª£c b·∫Øt ƒë·∫ßu chi·∫øm ƒë√≥ng th√†nh ph·ªë.",cat:"war"},
    {word:"revolution",def:"A forcible overthrow of a government or social order in favor of a new system.",example:"The revolution brought about significant changes.",viDef:"S·ª± l·∫≠t ƒë·ªï b·∫±ng v≈© l·ª±c c·ªßa m·ªôt ch√≠nh ph·ªß ho·∫∑c tr·∫≠t t·ª± x√£ h·ªôi ƒë·ªÉ ·ªßng h·ªô m·ªôt h·ªá th·ªëng m·ªõi.",viExample:"Cu·ªôc c√°ch m·∫°ng ƒë√£ mang l·∫°i nh·ªØng thay ƒë·ªïi ƒë√°ng k·ªÉ.",cat:"war"},
    {word:"resistance",def:"The refusal to accept or comply with something; the attempt to prevent something by action or argument.",example:"The resistance movement fought against the occupation.",viDef:"S·ª± t·ª´ ch·ªëi ch·∫•p nh·∫≠n ho·∫∑c tu√¢n theo ƒëi·ªÅu g√¨ ƒë√≥; n·ªó l·ª±c ngƒÉn ch·∫∑n ƒëi·ªÅu g√¨ ƒë√≥ b·∫±ng h√†nh ƒë·ªông ho·∫∑c l·∫≠p lu·∫≠n.",viExample:"Phong tr√†o kh√°ng chi·∫øn ƒë√£ chi·∫øn ƒë·∫•u ch·ªëng l·∫°i s·ª± chi·∫øm ƒë√≥ng.",cat:"war"},
    {word:"casualty",def:"A person killed or injured in a war or accident.",example:"There were many casualties in the battle.",viDef:"M·ªôt ng∆∞·ªùi b·ªã gi·∫øt ho·∫∑c b·ªã th∆∞∆°ng trong chi·∫øn tranh ho·∫∑c tai n·∫°n.",viExample:"C√≥ nhi·ªÅu th∆∞∆°ng vong trong tr·∫≠n ƒë√°nh.",cat:"war"},
    {word:"ammunition",def:"A supply or quantity of bullets and shells.",example:"The troops were running low on ammunition.",viDef:"M·ªôt ngu·ªìn cung ho·∫∑c s·ªë l∆∞·ª£ng ƒë·∫°n v√† v·ªè ƒë·∫°n.",viExample:"C√°c qu√¢n ƒë·ªôi ƒëang c·∫°n ki·ªát ƒë·∫°n d∆∞·ª£c.",cat:"war"},
    {word:"artillery",def:"Large-caliber guns used in warfare on land.",example:"The artillery bombarded the enemy positions.",viDef:"S√∫ng c·ª° l·ªõn ƒë∆∞·ª£c s·ª≠ d·ª•ng trong chi·∫øn tranh tr√™n b·ªô.",viExample:"Ph√°o binh ƒë√£ b·∫Øn ph√° c√°c v·ªã tr√≠ c·ªßa k·∫ª th√π.",cat:"war"},
    {word:"ceasefire",def:"A temporary suspension of fighting.",example:"The ceasefire allowed civilians to leave the city.",viDef:"M·ªôt s·ª± ƒë√¨nh ch·ªâ chi·∫øn ƒë·∫•u t·∫°m th·ªùi.",viExample:"L·ªánh ng·ª´ng b·∫Øn ƒë√£ cho ph√©p d√¢n th∆∞·ªùng r·ªùi th√†nh ph·ªë.",cat:"war"}
  ],
  finalBoss: [
    {word:"armistice",def:"An agreement made by opposing sides in a war to stop fighting for a certain time.",example:"The armistice was signed after months of negotiation.",viDef:"M·ªôt th·ªèa thu·∫≠n ƒë∆∞·ª£c th·ª±c hi·ªán b·ªüi c√°c b√™n ƒë·ªëi l·∫≠p trong m·ªôt cu·ªôc chi·∫øn ƒë·ªÉ ng·ª´ng chi·∫øn ƒë·∫•u trong m·ªôt kho·∫£ng th·ªùi gian nh·∫•t ƒë·ªãnh.",viExample:"Hi·ªáp ƒë·ªãnh ƒë√¨nh chi·∫øn ƒë√£ ƒë∆∞·ª£c k√Ω sau nhi·ªÅu th√°ng ƒë√†m ph√°n.",cat:"war"},
    {word:"siege",def:"A military operation in which an enemy surrounds a town or building, cutting off essential supplies.",example:"The siege of the city lasted for nearly a year.",viDef:"M·ªôt ho·∫°t ƒë·ªông qu√¢n s·ª± trong ƒë√≥ k·∫ª th√π bao v√¢y m·ªôt th·ªã tr·∫•n ho·∫∑c t√≤a nh√†, c·∫Øt ƒë·ª©t ngu·ªìn cung c·∫•p thi·∫øt y·∫øu.",viExample:"Cu·ªôc bao v√¢y th√†nh ph·ªë k√©o d√†i g·∫ßn m·ªôt nƒÉm.",cat:"war"},
    {word:"guerrilla",def:"A member of a small independent group taking part in irregular fighting, typically against larger regular forces.",example:"Guerrilla fighters used hit-and-run tactics.",viDef:"M·ªôt th√†nh vi√™n c·ªßa m·ªôt nh√≥m nh·ªè ƒë·ªôc l·∫≠p tham gia v√†o c√°c tr·∫≠n chi·∫øn kh√¥ng ƒë·ªÅu ƒë·∫∑n, th∆∞·ªùng ch·ªëng l·∫°i c√°c l·ª±c l∆∞·ª£ng th∆∞·ªùng quy l·ªõn h∆°n.",viExample:"C√°c chi·∫øn binh du k√≠ch ƒë√£ s·ª≠ d·ª•ng chi·∫øn thu·∫≠t ƒë√°nh v√† ch·∫°y.",cat:"war"},
    {word:"reconnaissance",def:"Military observation of a region to locate an enemy or ascertain strategic features.",example:"The plane was on a reconnaissance mission.",viDef:"Quan s√°t qu√¢n s·ª± m·ªôt khu v·ª±c ƒë·ªÉ ƒë·ªãnh v·ªã k·∫ª th√π ho·∫∑c x√°c ƒë·ªãnh c√°c ƒë·∫∑c ƒëi·ªÉm chi·∫øn l∆∞·ª£c.",viExample:"Chi·∫øc m√°y bay ƒëang th·ª±c hi·ªán nhi·ªám v·ª• trinh s√°t.",cat:"war"},
    {word:"battalion",def:"A large body of troops ready for battle, especially an infantry unit forming part of a brigade typically commanded by a lieutenant colonel.",example:"The battalion was sent to reinforce the front lines.",viDef:"M·ªôt l·ª±c l∆∞·ª£ng l·ªõn qu√¢n ƒë·ªôi s·∫µn s√†ng chi·∫øn ƒë·∫•u, ƒë·∫∑c bi·ªát l√† m·ªôt ƒë∆°n v·ªã b·ªô binh h√¨nh th√†nh m·ªôt ph·∫ßn c·ªßa m·ªôt l·ªØ ƒëo√†n th∆∞·ªùng ƒë∆∞·ª£c ch·ªâ huy b·ªüi m·ªôt trung t√°.",viExample:"Ti·ªÉu ƒëo√†n ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn ƒë·ªÉ tƒÉng c∆∞·ªùng cho ti·ªÅn tuy·∫øn.",cat:"war"},
    {word:"deployment",def:"The movement of troops or equipment to a place or position for military action.",example:"The deployment of additional troops was approved.",viDef:"S·ª± di chuy·ªÉn c·ªßa qu√¢n ƒë·ªôi ho·∫∑c thi·∫øt b·ªã ƒë·∫øn m·ªôt n∆°i ho·∫∑c v·ªã tr√≠ cho h√†nh ƒë·ªông qu√¢n s·ª±.",viExample:"Vi·ªác tri·ªÉn khai th√™m qu√¢n ƒë·ªôi ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát.",cat:"war"},
    {word:"armistice",def:"An agreement made by opposing sides in a war to stop fighting for a certain time.",example:"The armistice was signed after months of negotiation.",viDef:"M·ªôt th·ªèa thu·∫≠n ƒë∆∞·ª£c th·ª±c hi·ªán b·ªüi c√°c b√™n ƒë·ªëi l·∫≠p trong m·ªôt cu·ªôc chi·∫øn ƒë·ªÉ ng·ª´ng chi·∫øn ƒë·∫•u trong m·ªôt kho·∫£ng th·ªùi gian nh·∫•t ƒë·ªãnh.",viExample:"Hi·ªáp ƒë·ªãnh ƒë√¨nh chi·∫øn ƒë√£ ƒë∆∞·ª£c k√Ω sau nhi·ªÅu th√°ng ƒë√†m ph√°n.",cat:"war"},
    {word:"siege",def:"A military operation in which an enemy surrounds a town or building, cutting off essential supplies.",example:"The siege of the city lasted for nearly a year.",viDef:"M·ªôt ho·∫°t ƒë·ªông qu√¢n s·ª± trong ƒë√≥ k·∫ª th√π bao v√¢y m·ªôt th·ªã tr·∫•n ho·∫∑c t√≤a nh√†, c·∫Øt ƒë·ª©t ngu·ªìn cung c·∫•p thi·∫øt y·∫øu.",viExample:"Cu·ªôc bao v√¢y th√†nh ph·ªë k√©o d√†i g·∫ßn m·ªôt nƒÉm.",cat:"war"},
    {word:"guerrilla",def:"A member of a small independent group taking part in irregular fighting, typically against larger regular forces.",example:"Guerrilla fighters used hit-and-run tactics.",viDef:"M·ªôt th√†nh vi√™n c·ªßa m·ªôt nh√≥m nh·ªè ƒë·ªôc l·∫≠p tham gia v√†o c√°c tr·∫≠n chi·∫øn kh√¥ng ƒë·ªÅu ƒë·∫∑n, th∆∞·ªùng ch·ªëng l·∫°i c√°c l·ª±c l∆∞·ª£ng th∆∞·ªùng quy l·ªõn h∆°n.",viExample:"C√°c chi·∫øn binh du k√≠ch ƒë√£ s·ª≠ d·ª•ng chi·∫øn thu·∫≠t ƒë√°nh v√† ch·∫°y.",cat:"war"},
    {word:"reconnaissance",def:"Military observation of a region to locate an enemy or ascertain strategic features.",example:"The plane was on a reconnaissance mission.",viDef:"Quan s√°t qu√¢n s·ª± m·ªôt khu v·ª±c ƒë·ªÉ ƒë·ªãnh v·ªã k·∫ª th√π ho·∫∑c x√°c ƒë·ªãnh c√°c ƒë·∫∑c ƒëi·ªÉm chi·∫øn l∆∞·ª£c.",viExample:"Chi·∫øc m√°y bay ƒëang th·ª±c hi·ªán nhi·ªám v·ª• trinh s√°t.",cat:"war"},
    {word:"battalion",def:"A large body of troops ready for battle, especially an infantry unit forming part of a brigade typically commanded by a lieutenant colonel.",example:"The battalion was sent to reinforce the front lines.",viDef:"M·ªôt l·ª±c l∆∞·ª£ng l·ªõn qu√¢n ƒë·ªôi s·∫µn s√†ng chi·∫øn ƒë·∫•u, ƒë·∫∑c bi·ªát l√† m·ªôt ƒë∆°n v·ªã b·ªô binh h√¨nh th√†nh m·ªôt ph·∫ßn c·ªßa m·ªôt l·ªØ ƒëo√†n th∆∞·ªùng ƒë∆∞·ª£c ch·ªâ huy b·ªüi m·ªôt trung t√°.",viExample:"Ti·ªÉu ƒëo√†n ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn ƒë·ªÉ tƒÉng c∆∞·ªùng cho ti·ªÅn tuy·∫øn.",cat:"war"},
    {word:"deployment",def:"The movement of troops or equipment to a place or position for military action.",example:"The deployment of additional troops was approved.",viDef:"S·ª± di chuy·ªÉn c·ªßa qu√¢n ƒë·ªôi ho·∫∑c thi·∫øt b·ªã ƒë·∫øn m·ªôt n∆°i ho·∫∑c v·ªã tr√≠ cho h√†nh ƒë·ªông qu√¢n s·ª±.",viExample:"Vi·ªác tri·ªÉn khai th√™m qu√¢n ƒë·ªôi ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát.",cat:"war"}
  ]
};

/* ===== local storage helpers ===== */
function loadVocab(){
  let v = localStorage.getItem('wb_vocab');
  if(v) try{return JSON.parse(v);}catch(e){}
  return JSON.parse(JSON.stringify(defaultVocab));
}
let vocab = loadVocab();

let state = {
  currentLevel: 1,
  health: 100,
  armyStrength: 0,
  levelProgress: { correct: 0, total: 5 }, // level1: 5, level2: 7, level3: 10, finalBoss: 10/12
  badges: [],
  learnedWords: []
};
function loadState(){
  let s = localStorage.getItem('wb_state');
  if(s) try{state=Object.assign(state,JSON.parse(s));}catch(e){}
}
function saveState(){localStorage.setItem('wb_state',JSON.stringify(state));updateHUD();updateBarracks();}
loadState();

/* ===== HUD & UI wiring ===== */
function updateHUD(){
  document.getElementById('score').innerText = (LANG==='en'? 'Army: ' : 'Qu√¢n ƒë·ªôi: ') + state.armyStrength;
  document.getElementById('level').innerText = state.currentLevel;
  document.getElementById('health').innerText = state.health;
  document.getElementById('healthPercent').innerText = state.health + '%';
  document.getElementById('healthBar').style.width = state.health + '%';
  document.getElementById('strengthValue').innerText = state.armyStrength;
  document.getElementById('strengthBar').style.width = Math.min(state.armyStrength, 100) + '%';
  
  // Update level info
  let levelNames = {
    1: t('level1'),
    2: t('level2'),
    3: t('level3'),
    4: t('finalBoss')
  };
  document.getElementById('currentLevel').innerText = levelNames[state.currentLevel];
  
  // Update progress
  let progress = (state.levelProgress.correct / state.levelProgress.total) * 100;
  document.getElementById('levelProgress').style.width = progress + '%';
  document.getElementById('progressText').innerText = state.levelProgress.correct + '/' + state.levelProgress.total;
  
  // Update badges
  updateBadges();
}
updateHUD();

function updateBadges() {
  const badgesContainer = document.getElementById('badgesContainer');
  badgesContainer.innerHTML = '';
  
  if (state.badges.length === 0) {
    badgesContainer.innerHTML = `<div class="badge" style="background:#555">${t('noBadges')}</div>`;
    return;
  }
  
  const badgeNames = {
    'strategist': LANG === 'en' ? 'The Strategist' : 'Nh√† chi·∫øn l∆∞·ª£c',
    'commander': LANG === 'en' ? 'The Commander' : 'Ch·ªâ huy',
    'conqueror': LANG === 'en' ? 'The Conqueror' : 'Ng∆∞·ªùi chinh ph·ª•c'
  };
  
  state.badges.forEach(badge => {
    const badgeEl = document.createElement('div');
    badgeEl.className = 'badge';
    badgeEl.innerText = badgeNames[badge] || badge;
    badgesContainer.appendChild(badgeEl);
  });
}

function updateBarracks() {
  const barracksContent = document.getElementById('barracksContent');
  
  if (state.learnedWords.length === 0) {
    barracksContent.innerHTML = `<p style="color:var(--muted)">${t('barracksEmpty')}</p>`;
    return;
  }
  
  barracksContent.innerHTML = '<h4>Your Vocabulary Army:</h4>';
  
  const wordsList = document.createElement('div');
  wordsList.style.display = 'flex';
  wordsList.style.flexWrap = 'wrap';
  wordsList.style.gap = '8px';
  wordsList.style.marginTop = '10px';
  
  state.learnedWords.forEach(word => {
    const wordEl = document.createElement('div');
    wordEl.style.padding = '5px 10px';
    wordEl.style.background = 'rgba(138,194,73,0.2)';
    wordEl.style.borderRadius = '15px';
    wordEl.style.fontSize = '14px';
    wordEl.innerText = word;
    wordsList.appendChild(wordEl);
  });
  
  barracksContent.appendChild(wordsList);
}

const views = {battle:document.getElementById('view-battle'),barracks:document.getElementById('view-barracks'),edit:document.getElementById('view-edit')};
const btnBattle=document.getElementById('btn-battle'),btnBarracks=document.getElementById('btn-barracks'),btnEdit=document.getElementById('btn-edit');
btnBattle.onclick=()=>show('battle');btnBarracks.onclick=()=>show('barracks');btnEdit.onclick=()=>show('edit');
function show(v){
  for(let k in views){views[k].style.display='none';}
  btnBattle.classList.remove('active');btnBarracks.classList.remove('active');btnEdit.classList.remove('active');
  if(v==='battle'){views.battle.style.display='block';btnBattle.classList.add('active'); stopTimer(); resetBattleArea();}
  if(v==='barracks'){views.barracks.style.display='block';btnBarracks.classList.add('active'); updateBarracks();}
  if(v==='edit'){views.edit.style.display='block';btnEdit.classList.add('active');document.getElementById('vocabJson').value = JSON.stringify(vocab,null,2)}
}

/* ===== language toggles ===== */
document.getElementById('langEn').onclick=()=>{LANG='en';applyLang();};
document.getElementById('langVi').onclick=()=>{LANG='vi';applyLang();};
function applyLang(){
  document.getElementById('btn-battle').innerText = STRINGS[LANG].battle;
  document.getElementById('btn-barracks').innerText = STRINGS[LANG].barracks;
  document.getElementById('btn-edit').innerText = STRINGS[LANG].edit;
  document.getElementById('footer').innerText = STRINGS[LANG].tip;
  document.getElementById('btn-help').onclick = ()=>alert(STRINGS[LANG].how + '\n\n' + STRINGS[LANG].scoring);
  document.getElementById('nextBattle').innerText = STRINGS[LANG].startBattle;
  document.getElementById('questionText').innerText = STRINGS[LANG].pressStart;
  updateHUD();
}
applyLang();

/* ===== small controls ===== */
document.getElementById('btn-reset').onclick=()=>{
  if(confirm(LANG==='en'? 'Reset all progress and start over?':'B·∫°n c√≥ ch·∫Øc mu·ªën ƒë·∫∑t l·∫°i ti·∫øn tr√¨nh v√† b·∫Øt ƒë·∫ßu l·∫°i?')){
    localStorage.removeItem('wb_state');
    state = {
      currentLevel: 1,
      health: 100,
      armyStrength: 0,
      levelProgress: { correct: 0, total: 5 },
      badges: [],
      learnedWords: []
    };
    saveState();
    alert(LANG==='en'? 'Game reset. Good luck, Commander!' : 'ƒê√£ ƒë·∫∑t l·∫°i tr√≤ ch∆°i. Ch√∫c may m·∫Øn, Ch·ªâ huy!');
  }
};
document.getElementById('btn-help').onclick=()=>alert(STRINGS[LANG].how + '\n\n' + STRINGS[LANG].scoring);

/* ===== battle logic ===== */
let battleTimerId=null;let battleTime=20;let currentQ=null;
function pickQuestion(level){
  let pool;
  if(level === 4) {
    pool = vocab.finalBoss;
  } else {
    let levelKey = 'level' + level;
    pool = vocab[levelKey];
  }
  
  if(pool.length===0) return null;
  let correct = pool[Math.floor(Math.random()*pool.length)];
  let options = [correct];
  
  // Add 3 distractors from the same level
  while(options.length<4){
    let cand = pool[Math.floor(Math.random()*pool.length)];
    if(!options.find(o=>o.word===cand.word)) options.push(cand);
  }
  
  // Shuffle options
  for(let i=options.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[options[i],options[j]]=[options[j],options[i]]}
  return {q:correct,options};
}

document.getElementById('nextBattle').onclick=()=>startBattle();
function startBattle(){
  stopTimer();
  resetBattleArea();
  
  let q = pickQuestion(state.currentLevel);
  if(!q){
    document.getElementById('questionText').innerText=(LANG==='en'? 'No words available for this level.' : 'Kh√¥ng c√≥ t·ª´ n√†o cho c·∫•p ƒë·ªô n√†y.');
    return;
  }
  
  currentQ=q;
  document.getElementById('questionText').innerText = (LANG==='en'? 'What is the meaning of: "' : 'Nghƒ©a c·ªßa t·ª´ l√†: "') + q.q.word + '"?';
  let opts = document.getElementById('options');opts.innerHTML='';
  
  q.options.forEach(o=>{
    let b = document.createElement('div');
    b.className='option';
    b.innerText=o.def;
    b.onclick=()=>selectOption(b,o);
    opts.appendChild(b);
  });
  
  battleTime=20;
  document.getElementById('timer').innerText=battleTime+'s';
  battleTimerId=setInterval(()=>{
    battleTime--;
    document.getElementById('timer').innerText=battleTime+'s';
    if(battleTime<=0){
      stopTimer();
      revealAnswer(null);
    }
  },1000);
}

function resetBattleArea() {
  document.getElementById('questionText').innerText = STRINGS[LANG].pressStart;
  document.getElementById('options').innerHTML = '';
  document.getElementById('timer').innerText = '--';
  currentQ = null;
}

function stopTimer(){
  if(battleTimerId)clearInterval(battleTimerId);
  battleTimerId=null;
  document.getElementById('timer').innerText='--';
}

function selectOption(el,opt){
  stopTimer();
  if(!currentQ) return;
  
  let correct = currentQ.q.word===opt.word;
  if(correct){
    el.classList.add('correct');
    onCorrect();
  } else {
    el.classList.add('wrong');
    onWrong();
    revealAnswer(opt);
  }
  
  // Show correct answer
  let opts = document.querySelectorAll('.option');
  opts.forEach(o=>{
    if(o.innerText===currentQ.q.def) o.classList.add('correct');
  });
}

function revealAnswer(selected){
  if(!currentQ) return;
  
  let area = document.getElementById('questionText');
  let example = LANG==='en'? currentQ.q.example : currentQ.q.viExample;
  area.innerText = (LANG==='en'? 'Word: ' : 'T·ª´: ') + currentQ.q.word + 
                 '\n' + (LANG==='en'? 'Definition: ' : 'ƒê·ªãnh nghƒ©a: ') + currentQ.q.def + 
                 '\n' + (LANG==='en'? 'Example: ' : 'V√≠ d·ª•: ') + example;
}

function onCorrect(){
  state.armyStrength += 10;
  state.levelProgress.correct++;
  
  // Add word to learned words if not already there
  if(!state.learnedWords.includes(currentQ.q.word)){
    state.learnedWords.push(currentQ.q.word);
  }
  
  // Check if level is complete
  if(state.currentLevel === 4) {
    // Final boss - special handling
    if(state.levelProgress.correct >= 10) {
      // Player wins the game
      showLevelComplete();
    }
  } else if(state.levelProgress.correct >= state.levelProgress.total) {
    // Regular level complete
    showLevelComplete();
  }
  
  saveState();
}

function onWrong(){
  state.health -= 5;
  
  if(state.health <= 0) {
    state.health = 0;
    saveState();
    showGameOver();
  } else {
    saveState();
  }
}

function showGameOver() {
  document.getElementById('gameOverTitle').innerText = STRINGS[LANG].gameOver;
  document.getElementById('gameOverMessage').innerText = STRINGS[LANG].gameOverMsg;
  document.getElementById('restartBtn').innerText = STRINGS[LANG].restart;
  document.getElementById('gameOverModal').style.display = 'flex';
}

function showLevelComplete() {
  let badge = '';
  let title = '';
  
  if(state.currentLevel === 1) {
    badge = 'strategist';
    title = LANG === 'en' ? 'The Strategist' : 'Nh√† chi·∫øn l∆∞·ª£c';
  } else if(state.currentLevel === 2) {
    badge = 'commander';
    title = LANG === 'en' ? 'The Commander' : 'Ch·ªâ huy';
  } else if(state.currentLevel === 3) {
    badge = 'conqueror';
    title = LANG === 'en' ? 'The Conqueror' : 'Ng∆∞·ªùi chinh ph·ª•c';
  } else if(state.currentLevel === 4) {
    // Final boss completed - game won
    document.getElementById('levelCompleteTitle').innerText = LANG === 'en' ? 'Victory!' : 'Chi·∫øn th·∫Øng!';
    document.getElementById('levelCompleteMessage').innerText = LANG === 'en' ? 
      'Congratulations! You have conquered the Word Battlefield and become a master of war vocabulary!' : 
      'Ch√∫c m·ª´ng! B·∫°n ƒë√£ chinh ph·ª•c Chi·∫øn tr∆∞·ªùng T·ª´ v·ª±ng v√† tr·ªü th√†nh b·∫≠c th·∫ßy t·ª´ v·ª±ng chi·∫øn tranh!';
    document.getElementById('nextLevelBtn').innerText = LANG === 'en' ? 'Play Again' : 'Ch∆°i l·∫°i';
    document.getElementById('levelCompleteModal').style.display = 'flex';
    return;
  }
  
  // Add badge if not already earned
  if(!state.badges.includes(badge)) {
    state.badges.push(badge);
  }
  
  document.getElementById('levelCompleteTitle').innerText = STRINGS[LANG].levelComplete;
  document.getElementById('levelCompleteMessage').innerText = STRINGS[LANG].levelCompleteMsg + ' ' + 
    (LANG === 'en' ? `You've earned the "${title}" badge!` : `B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c huy hi·ªáu "${title}"!`);
  document.getElementById('nextLevelBtn').innerText = STRINGS[LANG].nextLevel;
  document.getElementById('levelCompleteModal').style.display = 'flex';
}

function nextLevel() {
  document.getElementById('levelCompleteModal').style.display = 'none';
  
  if(state.currentLevel === 4) {
    // Game completed - restart
    document.getElementById('btn-reset').click();
    return;
  }
  
  // Move to next level
  state.currentLevel++;
  
  // Set level progress requirements
  if(state.currentLevel === 2) {
    state.levelProgress = { correct: 0, total: 7 };
  } else if(state.currentLevel === 3) {
    state.levelProgress = { correct: 0, total: 10 };
  } else if(state.currentLevel === 4) {
    state.levelProgress = { correct: 0, total: 12 };
  }
  
  saveState();
  resetBattleArea();
}

// Modal event listeners
document.getElementById('restartBtn').onclick = function() {
  document.getElementById('gameOverModal').style.display = 'none';
  document.getElementById('btn-reset').click();
};

document.getElementById('nextLevelBtn').onclick = nextLevel;

/* ===== edit & save vocab ===== */
document.getElementById('saveVocab').onclick=()=>{
  try{
    let j = JSON.parse(document.getElementById('vocabJson').value);
    if(!j.level1 || !j.level2 || !j.level3 || !j.finalBoss) {
      throw (LANG==='en' ? 'Vocabulary must include level1, level2, level3, and finalBoss arrays' : 'T·ª´ v·ª±ng ph·∫£i bao g·ªìm c√°c m·∫£ng level1, level2, level3 v√† finalBoss');
    }
    
    vocab = j;
    localStorage.setItem('wb_vocab', JSON.stringify(vocab));
    alert(LANG==='en'? 'Saved successfully!' : 'ƒê√£ l∆∞u th√†nh c√¥ng!');
  } catch(e){
    alert((LANG==='en'? 'Error: ' : 'L·ªói: ') + e);
  }
};

document.getElementById('resetVocab').onclick=()=>{
  if(confirm(LANG==='en'? 'Reset vocabulary to default?':'B·∫°n c√≥ mu·ªën ƒë·∫∑t l·∫°i danh s√°ch t·ª´ v·ªÅ m·∫∑c ƒë·ªãnh?')){
    vocab = JSON.parse(JSON.stringify(defaultVocab));
    localStorage.removeItem('wb_vocab');
    document.getElementById('vocabJson').value=JSON.stringify(vocab,null,2);
    alert(LANG==='en'? 'Reset to default.' : 'ƒê√£ ƒë·∫∑t l·∫°i m·∫∑c ƒë·ªãnh.');
  }
};

/* ===== init ===== */
updateBarracks();
document.getElementById('vocabJson').value = JSON.stringify(vocab,null,2);

/* ===== download handler ===== */
document.getElementById('downloadBtn').addEventListener('click', (e)=>{
  const blob = new Blob([document.documentElement.outerHTML], {type: 'text/html'});
  const url = URL.createObjectURL(blob);
  e.currentTarget.href = url;
});
</script>
</body>
</html>
